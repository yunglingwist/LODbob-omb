import os
import pandas as pd
from rdflib import Graph, URIRef

# 1. Configuration
ttl_file = "scott_pilgrim_master.ttl" # Dosya adın tam olarak bu olmalı
nodes_out = "gephi_nodes.csv"
edges_out = "gephi_edges.csv"

def shorten(uri):
    """Simplifies URIs for better visualization in Gephi"""
    if "#" in uri: return uri.split("#")[-1]
    if "/" in uri: return uri.split("/")[-1]
    return uri

def convert_ttl_to_csv():
    if not os.path.exists(ttl_file):
        print(f"Error: {ttl_file} not found.")
        return

    print("Parsing Turtle file...")
    g = Graph()
    g.parse(ttl_file, format="turtle")

    nodes = set()
    edges = []

    # 2. Extract Triples
    for s, p, o in g:
        # We only want to visualize relations between local resources or specific types
        # Shorten URIs for cleaner labels
        src = shorten(str(s))
        pred = shorten(str(p))
        tgt = shorten(str(o))

        # Add to nodes set
        nodes.add(src)
        if isinstance(o, URIRef): # Only add objects to nodes if they are URIs (not literals)
            nodes.add(tgt)
            # Add to edges list
            edges.append({
                "Source": src,
                "Target": tgt,
                "Type": "Directed",
                "Label": pred
            })

    # 3. Create DataFrames
    df_nodes = pd.DataFrame([{"Id": n, "Label": n} for n in nodes])
    df_edges = pd.DataFrame(edges)

    # 4. Save to CSV
    df_nodes.to_csv(nodes_out, index=False)
    df_edges.to_csv(edges_out, index=False)
    
    print(f"Success! Created {nodes_out} and {edges_out}")

if __name__ == "__main__":
    convert_ttl_to_csv()